<section class="container mt-2" id="operationsPage">
  <header class="text-center">
    <h1 class="mb-2">Récapitulatif des opérations</h1>
  </header>

  @if (isLoading()) {
    <div class="ring">Loading
      <span class="loading"></span>
    </div>
  } @else {
  <!--  Filtres-->
    <section id="operations-date-filter" class="d-flex align-items-center mb-2 justify-content-center flex-wrap">
      <div class="mx-2">
        <button role="button" class="btn btn-primary" (click)="resetDateFilters()" title="Enlever le filtre par date">
          Toutes opérations
        </button>
      </div>
      <form [formGroup]="form" (ngSubmit)="onSubmitChangeDate()">
        <div class="d-flex align-items-center">
          <mat-form-field class="mx-2">
            <input
              matInput
              type="month"
              [value]="todayYear() + '-' + todayMonthString()"
              formControlName="rangeDate"
            />
          </mat-form-field>
          <div class="mx-2">
            <button id="filterButton" role="button" type="submit" class="bg-light">
              <fa-icon
                [icon]="faFilter"
                class="text-primary"
                style="font-size: 20px"
                title="Filtrer par date"
              ></fa-icon>
            </button>
          </div>
        </div>
      </form>
    </section>

    <section id="operations-filters" class="d-flex align-items-center mb-2 justify-content-center gap-3 flex-wrap">
      <form [formGroup]="formAccountFiltered" (ngSubmit)="onSubmitAccountFilter()" title="Filtrer par compte">
        <div class="d-flex align-items-center">
          <mat-form-field>
            <mat-label>Filtrer par compte</mat-label>
            <mat-select formControlName="account" (selectionChange)="onSubmitAccountFilter()">
              <mat-option value="">Tous les comptes</mat-option>
              @for (type of groupedCompteTypes(); track type) {
                <mat-optgroup [label]="type">
                  @for (compte of groupedComptes()[type]; track compte.id) {
                    <mat-option [value]="compte.id.toString()">
                      {{ compte.name }}
                    </mat-option>
                  }
                </mat-optgroup>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </form>
      <form [formGroup]="formCategoryFiltered" (ngSubmit)="onSubmitCategoryFilter()" title="Filtrer par catégorie">
        <div class="d-flex align-items-center">
          <mat-form-field>
            <mat-label>Filtrer par catégorie</mat-label>
            <mat-select formControlName="category" (selectionChange)="onSubmitCategoryFilter()">
              <mat-option value="">Toutes les catégories</mat-option>
              @for (category of categorieList; track category) {
                <mat-option [value]="category">{{ category }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </form>
      <div>
        <button
          class="btn"
          [class.btn-primary]="selectedType() !== true"
          [class.btn-outline-primary]="selectedType() === true"
          (click)="typeFilter(true)"
          role="button"
        >
          Crédits
        </button>
      </div>
      <div>
        <button
          class="btn"
          [class.btn-danger]="selectedType() === null || selectedType() === true"
          [class.btn-outline-danger]="selectedType() === false"
          (click)="typeFilter(false)"
          role="button"
        >
          Débits
        </button>
      </div>
      <div>
        <button class="btn btn-outline-dark" (click)="resetAllFilters()" role="button">Supprimer les filtres</button>
      </div>
    </section>

    <section class="row mt-2 pb-5" id="dataToPrint">
      <main class="col-lg-8">
        <!--  Recap montants opérations du mois + télécharger-->
        <summary id="operations-summary" class="row">
          <div class="text-success col-lg-3 col-6">
            Crédit = <fa-icon [icon]="faArrowUp"></fa-icon>
            {{ totalCredit() | number: "1.0-2":"fr" }}€
          </div>
          <div class="text-danger col-lg-3 col-6">
            Débit = <fa-icon [icon]="faArrowDown"></fa-icon>
            {{ totalDebit() | number: "1.0-2":"fr" }}€
          </div>
          @if (totalCredit() + totalDebit() >= 0) {
            <div class="text-success col-lg-4 col-6">
              Différence = <fa-icon [icon]="faArrowUp"></fa-icon>
              {{ totalCredit() + totalDebit() | number: "1.0-2":"fr" }}€
            </div>
          } @else {
            <div class="text-danger col-lg-4 col-6">
              Différence = <fa-icon [icon]="faArrowDown"></fa-icon>
              {{ totalCredit() + totalDebit() | number: "1.0-2":"fr" }}€
            </div>
          }
          <div class="col-lg-1 col-5">
            <a href="javascript:;" (click)="export('operations')">
              <fa-icon
                [icon]="faDownload"
                class="text-primary"
                style="font-size: 20px"
                title="Télécharger les opérations"
              ></fa-icon>
            </a>
          </div>
        </summary>

        <!-- Affichage des opérations -->
        <article id="liste-operations">
          <!--  Ajouter une opération-->
          <div class="d-flex justify-content-center">
            <a href="javascript:;" (click)="AddOperation()">
              <fa-icon
                [icon]="faPlus"
                class="text-primary"
                style="font-size: 50px"
                title="Ajouter une opération"
              ></fa-icon>
            </a>
          </div>

          <div class="row d-flex justify-content-evenly">
            @for (card of paginatedOperations(); track card.id) {
              <div class="card my-2 mx-1 col-lg-5 px-0">
                <h5 class="card-header text-center" [class]="card.classCSS">
                  {{ card.categorie }}
                </h5>
                <div class="card-body">
                  <h4 class="card-title text-center">{{ card.description1 }}</h4>
                  @if (card.montant >= 0) {
                    <div class="text-success d-flex justify-content-center">
                      <fa-icon [icon]="faArrowUp" class="mx-2"></fa-icon>
                      <span class="badge-montant">{{ card.montant | number: "1.0-2":"fr" }}€</span>
                    </div>
                  } @else {
                    <div class="text-danger d-flex justify-content-center">
                      <fa-icon [icon]="faArrowDown" class="mx-2"></fa-icon>
                      <span class="badge-montant">{{ card.montant | number: "1.0-2":"fr" }}€</span>
                    </div>
                  }
                  <div class="d-flex justify-content-evenly">
                    <div>{{ card.operationDate | date: "d MMMM y" }}</div>
                    <div>{{ card.compteName }}</div>
                  </div>
                  <div class="d-flex justify-content-evenly">
                    <div>
                      <button (click)="openOperationDetail(card)" class="btn" title="Mettre à jour l'opération" role="button">
                        <fa-icon [icon]="faPen"></fa-icon>
                      </button>
                    </div>
                    <div>
                      <button (click)="openConfirmation(card)" class="btn" title="Supprimer l'opération" role="button">
                        <fa-icon [icon]="faTrashCan" style="color: red"></fa-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </article>

        <section id="pagination" class="my-2">
          <div class="d-flex justify-content-center my-2">
            <label>
              Opérations par page :
              <select [value]="pageSize()" (change)="setPageSize($event)" class="rounded p-2">
                @for (size of [6,12,50]; track size) {
                  <option [value]="size">{{ size }}</option>
                }
              </select>
              / {{ totalItems()}}
            </label>
          </div>

          <div class="d-flex justify-content-center">
            @if (currentPage() > 0) {
              <button (click)="goToFirstPage()" [disabled]="currentPage() <= 0" class="mx-2 rounded" role="button" title="Aller à la première page">
                <fa-icon [icon]="faAnglesLeft" class="cursor-pointer"></fa-icon>
              </button>

              <button (click)="prevPage()" [disabled]="currentPage() <= 0" class="mx-2 rounded" role="button" title="Aller à la page précédente">
                <fa-icon [icon]="faAngleLeft" class="cursor-pointer"></fa-icon>
              </button>
            }

            <span class="mx-2">Page {{ currentPage() + 1 }} / {{ totalPages() }}</span>

            @if (currentPage() + 1 < totalPages()) {
              <button (click)="nextPage()" [disabled]="currentPage() + 1 >= totalPages()" class="mx-2 rounded" role="button" title="Aller à la page suivante">
                <fa-icon [icon]="faAngleRight" class="cursor-pointer"></fa-icon>
              </button>

              <button (click)="goToLastPage()" [disabled]="currentPage() + 1 >= totalPages()" class="mx-2 rounded" role="button" title="Aller à la dernière page">
                <fa-icon [icon]="faAnglesRight" class="cursor-pointer"></fa-icon>
              </button>
            }
          </div>
        </section>

      </main>

      <aside class="col-lg-4">
        <!--  Ajout de compte + télécharger comptes-->
        <div class="d-flex justify-content-evenly">
          <div>
            <a href="javascript:;" (click)="AddAccount()">
              <fa-icon
                [icon]="faPlus"
                class="text-primary"
                style="font-size: 20px"
                title="Ajouter un compte"
              ></fa-icon>
            </a>
          </div>
          <div>
            <a href="javascript:;" (click)="export('comptes')" class="mx-5">
              <fa-icon
                [icon]="faDownload"
                class="text-primary"
                style="font-size: 20px"
                title="Télécharger les comptes"
              ></fa-icon>
            </a>
          </div>
        </div>

        <!--  Récap des comptes-->
        <div>
          <table class="table">
            <thead>
            <tr>
              <th scope="col">Compte</th>
              <th scope="col">Solde</th>
              <th scope="col">Crédit</th>
              <th scope="col">Débit</th>
            </tr>
            </thead>
            <tbody>
              @for (compte of monthlyHistoryPerAccount(); track compte.name) {
                <tr>
                  <td>{{ compte.name }}</td>
                  <td>{{ compte.soldeFin | number:"1.0-2":"fr" }}€</td>
                  <td class="text-success">{{ compte.totalCredit | number:"1.0-2":"fr" }}€</td>
                  <td class="text-danger">{{ compte.totalDebit | number:"1.0-2":"fr" }}€</td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!--  Graphique par catégorie-->
        <div class="mb-5">
          <ngx-charts-pie-chart
            class="pt-0 mt-0"
            id="printChart"
            (window:resize)="onResize($event)"
            [results]="spendByCategory()"
            [legend]="false"
            [legendTitle]="'Dépense par catégorie'"
            [view]="[width(), 400]"
            [labels]="true"
          >
          </ngx-charts-pie-chart>
        </div>
      </aside>
    </section>
  }
</section>
